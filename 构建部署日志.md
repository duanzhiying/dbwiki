# 数据库课程实验资源平台 - 构建部署日志

## 项目概述
- **项目名称**: 数据库课程实验资源平台 (dbwiki)
- **技术栈**: MkDocs + Material主题
- **部署平台**: Vercel
- **代码仓库**: Gitee (主仓库) + GitHub (镜像)
- **开始时间**: 2024年12月

---

## 部署历程

### 2025-09-04 初始部署尝试

#### 问题描述
首次在 Vercel 部署时遇到构建失败，错误信息：
```
sh: line 1: pip: command not found
Error: Command "pip install -r requirements.txt && mkdocs build" exited with 127
```

#### 问题分析
- Vercel 默认构建环境没有安装 Python
- 无法执行 `pip install` 命令
- 导致 MkDocs 无法安装和构建

#### 解决方案
1. **创建 `vercel.json` 配置文件**
   ```json
   {
     "version": 2,
     "buildCommand": "python3 -m pip install -r requirements.txt && mkdocs build --clean",
     "outputDirectory": "site",
     "env": {
       "PYTHON_VERSION": "3.9"
     }
   }
   ```

2. **更新 `requirements.txt`**
   ```
   mkdocs
   mkdocs-material
   pymdown-extensions
   mkdocs-material-extensions
   ```

3. **保留 `runtime.txt`**
   ```
   python-3.9
   ```

#### 结果
❌ 仍然失败，错误信息显示仍在执行旧的构建命令

---

### 2025-09-04 第二次尝试

#### 问题描述
错误日志显示：
```
sh: line 1: mkdocs: command not found
Error: Command "python3 -m pip install -r requirements.txt && mkdocs build --clean" exited with 127
```

#### 问题分析
- 即使安装了 mkdocs，PATH 中找不到可执行文件
- 需要使用 Python 模块方式调用

#### 解决方案
**更新 `vercel.json` 构建命令**
```json
{
  "version": 2,
  "buildCommand": "python3 -m pip install -r requirements.txt && python3 -m mkdocs build --clean",
  "outputDirectory": "site",
  "env": {
    "PYTHON_VERSION": "3.9"
  }
}
```

#### 结果
❌ 仍然失败，出现新的错误

---

### 2024-12-19 第三次尝试

#### 问题描述
错误日志显示：
```
ERROR   -  Config value 'docs_dir': The path '/vercel/path1/docs' isn't an existing directory.
Aborted with a configuration error!
Error: Command "python3 -m pip install -r requirements.txt && python3 -m mkdocs build --clean" exited with 1
```

#### 问题分析
- `mkdocs.yml` 中引用的文档文件在仓库中缺失
- 需要补齐所有被引用的文档文件

#### 解决方案
**补齐缺失的文档文件**

1. **创建 `docs/index.md`**
2. **创建 `docs/3_avoidance_guides/transaction_死锁避免_teacher.md`**
3. **创建 `docs/4_excellent_labs/lab1_基础查询_student.md`**
4. **创建 `docs/5_course_designs/library_管理系统_student.md`**

#### 结果
✅ **构建成功！** 网站成功部署到 Vercel

---

## 最终配置

### 关键文件

#### `vercel.json`
```json
{
  "version": 2,
  "buildCommand": "python3 -m pip install -r requirements.txt && python3 -m mkdocs build --clean",
  "outputDirectory": "site",
  "env": {
    "PYTHON_VERSION": "3.9"
  }
}
```

#### `requirements.txt`
```
mkdocs
mkdocs-material
pymdown-extensions
mkdocs-material-extensions
```

#### `runtime.txt`
```
python-3.9
```

### Vercel 控制台设置
- **Build Command**: 留空（使用仓库配置）
- **Output Directory**: 留空（使用仓库配置）
- **Framework Preset**: Other 或 Static Site
- **Environment Variables**: 无自定义变量

---

## 经验总结

### 关键学习点

1. **Vercel 配置优先级**
   - 控制台设置 > 仓库 `vercel.json` > 默认配置
   - 建议优先使用仓库配置文件

2. **Python 环境处理**
   - Vercel 需要显式指定 Python 版本
   - 使用 `python3 -m pip` 和 `python3 -m mkdocs` 比直接调用可执行文件更可靠

3. **依赖管理**
   - 确保 `requirements.txt` 包含所有 `mkdocs.yml` 中使用的插件
   - 检查 `markdown_extensions` 配置对应的包

4. **文档结构完整性**
   - MkDocs 要求所有在 `nav` 中引用的文件必须存在
   - 缺失文件会导致构建失败

5. **构建命令最佳实践**
   - 使用 `--clean` 参数确保每次构建都是干净的
   - 通过 Python 模块方式调用工具，避免 PATH 问题

### 故障排查流程

1. **检查错误日志**：确定具体失败原因
2. **验证配置文件**：确保 `vercel.json` 配置正确
3. **检查依赖**：确认 `requirements.txt` 完整
4. **验证文档结构**：确保所有引用文件存在
5. **本地测试**：在本地环境测试构建命令

### 预防措施

- 在提交代码前，本地运行构建命令测试
- 保持文档结构与 `mkdocs.yml` 配置同步
- 定期更新依赖版本
- 使用版本控制管理配置文件

---



*最后更新：2025-09-04*
*维护者：kidzying*
